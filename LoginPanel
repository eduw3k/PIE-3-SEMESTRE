package javaapplication1.ui;

import javaapplication1.dao.UserDAO;
import javaapplication1.model.*;
import javax.swing.*;
import java.awt.*;
import java.sql.SQLException;
import java.util.Optional;

public class LoginPanel extends JPanel {
    private JFrame parent;
    private JTextField emailField;
    private JPasswordField passField;
    private JButton btnLogin, btnRegister;

    public LoginPanel(JFrame parent){
        this.parent = parent;
        setLayout(new BorderLayout(10,10));
        JPanel center = new JPanel(new GridLayout(5,1,5,5));
        emailField = new JTextField();
        passField = new JPasswordField();

        center.add(new JLabel("Email:")); center.add(emailField);
        center.add(new JLabel("Senha:")); center.add(passField);

        add(center, BorderLayout.CENTER);

        JPanel south = new JPanel();
        btnLogin = new JButton("Entrar");
        btnRegister = new JButton("Criar Conta");
        south.add(btnLogin); south.add(btnRegister);
        add(south, BorderLayout.SOUTH);

        btnRegister.addActionListener(e -> {
            parent.setContentPane(new RegisterPanel(parent));
            parent.revalidate();
        });

        btnLogin.addActionListener(e -> {
            String email = emailField.getText().trim();
            String senha = new String(passField.getPassword());
            try {
                UserDAO dao = new UserDAO();
                Optional<Usuario> u = dao.authenticate(email, senha);
                if (u.isEmpty()) {
                    JOptionPane.showMessageDialog(this, "Credenciais inv√°lidas.");
                    return;
                }
                Usuario user = u.get();
                if ("CLIENTE".equalsIgnoreCase(user.getTipo())) {
                    parent.setContentPane(new ClientePanel(parent, (Cliente) user));
                } else {
                    parent.setContentPane(new CorretorPanel(parent, (Corretor) user));
                }
                parent.revalidate();
            } catch (SQLException ex) {
                ex.printStackTrace();
                JOptionPane.showMessageDialog(this, "Erro de banco: " + ex.getMessage());
            }
        });
    }
}
